<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pok√©mon RPG</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: #2c3e50;
            overflow: hidden;
        }

        #gameCanvas {
            border: 4px solid #34495e;
            display: block;
            margin: 20px auto;
            background: #7ec850;
        }

        #ui {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            min-width: 200px;
        }

        #dialogue {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 20px;
            border-radius: 10px;
            max-width: 600px;
            width: 90%;
            display: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }

        #dialogue.active {
            display: block;
        }

        #dialogue-text {
            margin-bottom: 10px;
            line-height: 1.5;
        }

        #dialogue-continue {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            float: right;
        }

        #dialogue-continue:hover {
            background: #2980b9;
        }

        .choice-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            display: block;
            width: 100%;
        }

        .choice-btn:hover {
            background: #c0392b;
        }

        #battle {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        #battle.active {
            display: flex;
        }

        .pokemon-display {
            display: flex;
            justify-content: space-around;
            width: 80%;
            margin-bottom: 30px;
        }

        .pokemon-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            min-width: 200px;
        }

        .pokemon-shape {
            width: 80px;
            height: 80px;
            margin: 10px auto;
            border-radius: 50%;
        }

        .hp-bar {
            width: 100%;
            height: 20px;
            background: #ddd;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .hp-fill {
            height: 100%;
            background: #2ecc71;
            transition: width 0.3s;
        }

        .hp-fill.low {
            background: #e74c3c;
        }

        .battle-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .battle-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        .battle-btn:hover {
            background: #2980b9;
        }

        .battle-btn.capture {
            background: #e74c3c;
        }

        .battle-btn.capture:hover {
            background: #c0392b;
        }

        #stats {
            margin-top: 10px;
        }

        .stat-line {
            margin: 5px 0;
            font-size: 14px;
        }

        #pokemon-team {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 2px solid #ddd;
        }

        .team-pokemon {
            display: flex;
            align-items: center;
            margin: 5px 0;
            padding: 5px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .team-pokemon-shape {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin-right: 10px;
        }

        #battle-log {
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            max-width: 600px;
            min-height: 100px;
            max-height: 150px;
            overflow-y: auto;
        }

        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #3498db;
            padding-left: 10px;
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas" width="800" height="600"></canvas>
    
    <div id="ui">
        <h3>Joueur</h3>
        <div class="stat-line">Position: <span id="player-pos">0, 0</span></div>
        <div class="stat-line">Pok√©balls: <span id="pokeball-count">5</span></div>
        <div id="pokemon-team">
            <strong>√âquipe:</strong>
            <div id="team-list"></div>
        </div>
    </div>

    <div id="dialogue">
        <div id="dialogue-text"></div>
        <div id="dialogue-choices"></div>
        <button id="dialogue-continue">Continuer</button>
    </div>

    <div id="battle">
        <div class="pokemon-display">
            <div class="pokemon-card">
                <h3>Pok√©mon Sauvage</h3>
                <div id="wild-pokemon-shape" class="pokemon-shape"></div>
                <div id="wild-pokemon-name"></div>
                <div class="hp-bar">
                    <div id="wild-hp" class="hp-fill" style="width: 100%"></div>
                </div>
                <div id="wild-pokemon-hp-text">PV: 100/100</div>
            </div>
            <div class="pokemon-card">
                <h3>Votre Pok√©mon</h3>
                <div id="player-pokemon-shape" class="pokemon-shape"></div>
                <div id="player-pokemon-name"></div>
                <div class="hp-bar">
                    <div id="player-hp" class="hp-fill" style="width: 100%"></div>
                </div>
                <div id="player-pokemon-hp-text">PV: 100/100</div>
            </div>
        </div>
        <div id="battle-log"></div>
        <div class="battle-actions">
            <button class="battle-btn" onclick="game.battle.attack()">Attaquer</button>
            <button class="battle-btn capture" onclick="game.battle.capture()">Capturer</button>
            <button class="battle-btn" onclick="game.battle.flee()">Fuir</button>
        </div>
    </div>

    <script>
         const game = {
            canvas: null,
            ctx: null,
            player: {
                x: 400,
                y: 300,
                size: 30,
                speed: 3,
                color: '#e74c3c',
                pokeballs: 5,
                team: [],
                hasStarter: false
            },
            keys: {},
            map: {
                width: 800,
                height: 600,
                tiles: []
            },
            npcs: [],
            buildings: [],
            wildGrass: [],
            dialogue: {
                active: false,
                currentDialogue: null,
                callback: null
            },
            battle: null,

            init() {
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.setupMap();
                this.setupEventListeners();
                this.gameLoop();
            },

            setupMap() {
                // Laboratoire du Professeur Chen
                this.buildings.push({
                    x: 350,
                    y: 200,
                    width: 100,
                    height: 80,
                    color: '#8e44ad',
                    type: 'lab',
                    name: 'Laboratoire'
                });

                // Centre Pok√©mon
                this.buildings.push({
                    x: 100,
                    y: 100,
                    width: 80,
                    height: 80,
                    color: '#e74c3c',
                    type: 'pokecenter',
                    name: 'Centre Pok√©mon'
                });

                // Magasin
                this.buildings.push({
                    x: 620,
                    y: 100,
                    width: 80,
                    height: 80,
                    color: '#f39c12',
                    type: 'shop',
                    name: 'Magasin'
                });

                // Professeur Chen
                this.npcs.push({
                    x: 400,
                    y: 240,
                    size: 25,
                    color: '#3498db',
                    name: 'Prof. Chen',
                    type: 'professor'
                });

                // Herbes hautes (zones de rencontre)
                for (let i = 0; i < 10; i++) {
                    this.wildGrass.push({
                        x: Math.random() * 700 + 50,
                        y: Math.random() * 500 + 50,
                        width: 60,
                        height: 60,
                        color: '#27ae60'
                    });
                }

                // Routes
                this.buildings.push({
                    x: 0,
                    y: 250,
                    width: 800,
                    height: 100,
                    color: '#95a5a6',
                    type: 'road',
                    name: 'Route 1'
                });
            },

            setupEventListeners() {
                document.addEventListener('keydown', (e) => {
                    this.keys[e.key] = true;
                    if (e.key === ' ' && !this.dialogue.active && !this.battle) {
                        this.checkInteraction();
                    }
                });

                document.addEventListener('keyup', (e) => {
                    this.keys[e.key] = false;
                });

                document.getElementById('dialogue-continue').addEventListener('click', () => {
                    this.closeDialogue();
                });
            },

            update() {
                if (this.dialogue.active || this.battle) return;

                let newX = this.player.x;
                let newY = this.player.y;

                if (this.keys['ArrowLeft'] || this.keys['q']) newX -= this.player.speed;
                if (this.keys['ArrowRight'] || this.keys['d']) newX += this.player.speed;
                if (this.keys['ArrowUp'] || this.keys['z']) newY -= this.player.speed;
                if (this.keys['ArrowDown'] || this.keys['s']) newY += this.player.speed;

                // Limites de la carte
                newX = Math.max(this.player.size, Math.min(this.map.width - this.player.size, newX));
                newY = Math.max(this.player.size, Math.min(this.map.height - this.player.size, newY));

                this.player.x = newX;
                this.player.y = newY;

                // V√©rification des herbes hautes
                this.checkWildEncounter();

                // Mise √† jour UI
                document.getElementById('player-pos').textContent = `${Math.floor(this.player.x)}, ${Math.floor(this.player.y)}`;
            },

            draw() {
                this.ctx.fillStyle = '#7ec850';
                this.ctx.fillRect(0, 0, this.map.width, this.map.height);

                // Dessiner les routes
                this.buildings.forEach(building => {
                    if (building.type === 'road') {
                        this.ctx.fillStyle = building.color;
                        this.ctx.fillRect(building.x, building.y, building.width, building.height);
                    }
                });

                // Dessiner les herbes hautes
                this.wildGrass.forEach(grass => {
                    this.ctx.fillStyle = grass.color;
                    this.ctx.fillRect(grass.x, grass.y, grass.width, grass.height);
                    // Motif d'herbe
                    this.ctx.fillStyle = '#229954';
                    for (let i = 0; i < 5; i++) {
                        this.ctx.fillRect(grass.x + i * 12 + 5, grass.y + 10, 3, 20);
                        this.ctx.fillRect(grass.x + i * 12 + 5, grass.y + 35, 3, 15);
                    }
                });

                // Dessiner les b√¢timents
                this.buildings.forEach(building => {
                    if (building.type !== 'road') {
                        this.ctx.fillStyle = building.color;
                        this.ctx.fillRect(building.x, building.y, building.width, building.height);
                        // Toit
                        this.ctx.fillStyle = '#34495e';
                        this.ctx.beginPath();
                        this.ctx.moveTo(building.x - 10, building.y);
                        this.ctx.lineTo(building.x + building.width / 2, building.y - 20);
                        this.ctx.lineTo(building.x + building.width + 10, building.y);
                        this.ctx.fill();
                        // Texte
                        this.ctx.fillStyle = 'white';
                        this.ctx.font = '12px Arial';
                        this.ctx.textAlign = 'center';
                        this.ctx.fillText(building.name, building.x + building.width / 2, building.y + building.height / 2);
                    }
                });

                // Dessiner les NPCs
                this.npcs.forEach(npc => {
                    this.ctx.fillStyle = npc.color;
                    this.ctx.beginPath();
                    this.ctx.arc(npc.x, npc.y, npc.size, 0, Math.PI * 2);
                    this.ctx.fill();
                    this.ctx.fillStyle = 'white';
                    this.ctx.font = '10px Arial';
                    this.ctx.textAlign = 'center';
                    this.ctx.fillText(npc.name, npc.x, npc.y + npc.size + 15);
                });

                // Dessiner le joueur
                this.ctx.fillStyle = this.player.color;
                this.ctx.beginPath();
                this.ctx.arc(this.player.x, this.player.y, this.player.size, 0, Math.PI * 2);
                this.ctx.fill();
                // Yeux
                this.ctx.fillStyle = 'white';
                this.ctx.beginPath();
                this.ctx.arc(this.player.x - 8, this.player.y - 5, 6, 0, Math.PI * 2);
                this.ctx.arc(this.player.x + 8, this.player.y - 5, 6, 0, Math.PI * 2);
                this.ctx.fill();
                this.ctx.fillStyle = 'black';
                this.ctx.beginPath();
                this.ctx.arc(this.player.x - 8, this.player.y - 5, 3, 0, Math.PI * 2);
                this.ctx.arc(this.player.x + 8, this.player.y - 5, 3, 0, Math.PI * 2);
                this.ctx.fill();
            },

            checkInteraction() {
                // V√©rifier interaction avec NPCs
                this.npcs.forEach(npc => {
                    const dist = Math.hypot(this.player.x - npc.x, this.player.y - npc.y);
                    if (dist < 80) {
                        this.interactWithNPC(npc);
                    }
                });

                // V√©rifier interaction avec b√¢timents
                this.buildings.forEach(building => {
                    if (building.type !== 'road') {
                        const inRange = this.player.x > building.x - 50 &&
                                      this.player.x < building.x + building.width + 50 &&
                                      this.player.y > building.y - 50 &&
                                      this.player.y < building.y + building.height + 50;
                        if (inRange) {
                            this.interactWithBuilding(building);
                        }
                    }
                });
            },

            interactWithNPC(npc) {
                if (npc.type === 'professor' && !this.player.hasStarter) {
                    this.showDialogue(
                        "Professeur Chen: Bonjour jeune dresseur ! Bienvenue dans le monde des Pok√©mon ! Avant de commencer ton aventure, tu dois choisir ton premier Pok√©mon. Lequel choisis-tu ?",
                        () => this.chooseStarter()
                    );
                } else if (npc.type === 'professor' && this.player.hasStarter) {
                    this.showDialogue("Professeur Chen: Comment se passe ton aventure ? Continue d'explorer et de capturer des Pok√©mon !");
                }
            },

            interactWithBuilding(building) {
                if (building.type === 'pokecenter') {
                    this.showDialogue("Infirmi√®re Joy: Bienvenue au Centre Pok√©mon ! Vos Pok√©mon ont √©t√© soign√©s !", () => {
                        this.player.team.forEach(p => {
                            p.currentHp = p.maxHp;
                        });
                        this.updateTeamDisplay();
                    });
                } else if (building.type === 'shop') {
                    this.showDialogue("Vendeur: Bienvenue √† la Boutique Pok√©mon !", () => {
                        this.showShop();
                    });
                }
            },

            showShop() {
                const choicesDiv = document.getElementById('dialogue-choices');
                choicesDiv.innerHTML = `
                    <button class="choice-btn" onclick="game.buyPokeballs(5)">Acheter 5 Pok√©balls (Gratuit pour le jeu)</button>
                    <button class="choice-btn" onclick="game.closeDialogue()">Partir</button>
                `;
                document.getElementById('dialogue-continue').style.display = 'none';
            },

            buyPokeballs(amount) {
                this.player.pokeballs += amount;
                document.getElementById('pokeball-count').textContent = this.player.pokeballs;
                this.showDialogue(`Vous avez re√ßu ${amount} Pok√©balls !`);
            },

            chooseStarter() {
                const choicesDiv = document.getElementById('dialogue-choices');
                choicesDiv.innerHTML = `
                    <button class="choice-btn" onclick="game.selectStarter('Salameche')">Salam√®che (Feu üî¥)</button>
                    <button class="choice-btn" onclick="game.selectStarter('Carapuce')">Carapuce (Eau üîµ)</button>
                    <button class="choice-btn" onclick="game.selectStarter('Bulbizarre')">Bulbizarre (Plante üü¢)</button>
                `;
                document.getElementById('dialogue-continue').style.display = 'none';
            },

            selectStarter(name) {
                const starters = {
                    'Salameche': { name: 'Salam√®che', type: 'Feu', color: '#ff6b4a', attack: 52, maxHp: 39 },
                    'Carapuce': { name: 'Carapuce', type: 'Eau', color: '#4a9eff', attack: 48, maxHp: 44 },
                    'Bulbizarre': { name: 'Bulbizarre', type: 'Plante', color: '#4aff6b', attack: 49, maxHp: 45 }
                };

                const starter = starters[name];
                starter.currentHp = starter.maxHp;
                starter.level = 5;
                this.player.team.push(starter);
                this.player.hasStarter = true;
                
                this.updateTeamDisplay();
                this.showDialogue(`F√©licitations ! Vous avez choisi ${starter.name} ! Bonne chance dans votre aventure !`);
            },

            checkWildEncounter() {
                if (this.player.team.length === 0) return;

                this.wildGrass.forEach(grass => {
                    if (this.player.x > grass.x && this.player.x < grass.x + grass.width &&
                        this.player.y > grass.y && this.player.y < grass.y + grass.height) {
                        if (Math.random() < 0.01) {
                            this.startWildBattle();
                        }
                    }
                });
            },

            startWildBattle() {
                const wildPokemon = this.generateWildPokemon();
                const playerPokemon = this.player.team[0];

                this.battle = {
                    wild: wildPokemon,
                    player: playerPokemon,
                    turn: 'player',
                    log: []
                };

                this.showBattle();
            },

            generateWildPokemon() {
                const wildTypes = [
                    { name: 'Rattata', type: 'Normal', color: '#a8a878', attack: 30, maxHp: 30, level: 3 },
                    { name: 'Pikachu', type: '√âlectrik', color: '#f8d030', attack: 35, maxHp: 35, level: 4 },
                    { name: 'Roucool', type: 'Vol', color: '#a890f0', attack: 32, maxHp: 40, level: 3 },
                    { name: 'Chenipan', type: 'Insecte', color: '#a8b820', attack: 25, maxHp: 45, level: 3 },
                    { name: 'Aspicot', type: 'Insecte', color: '#a8b820', attack: 28, maxHp: 40, level: 3 }
                ];

                const pokemon = wildTypes[Math.floor(Math.random() * wildTypes.length)];
                pokemon.currentHp = pokemon.maxHp;
                return pokemon;
            },

            showBattle() {
                document.getElementById('battle').classList.add('active');
                this.updateBattleDisplay();
                this.addBattleLog(`Un ${this.battle.wild.name} sauvage appara√Æt !`);
            },

            updateBattleDisplay() {
                const wild = this.battle.wild;
                const player = this.battle.player;

                document.getElementById('wild-pokemon-shape').style.backgroundColor = wild.color;
                document.getElementById('wild-pokemon-name').textContent = `${wild.name} (Niv.${wild.level})`;
                document.getElementById('wild-pokemon-hp-text').textContent = `PV: ${Math.max(0, wild.currentHp)}/${wild.maxHp}`;
                
                const wildHpPercent = (wild.currentHp / wild.maxHp) * 100;
                const wildHpBar = document.getElementById('wild-hp');
                wildHpBar.style.width = wildHpPercent + '%';
                wildHpBar.className = 'hp-fill' + (wildHpPercent < 30 ? ' low' : '');

                document.getElementById('player-pokemon-shape').style.backgroundColor = player.color;
                document.getElementById('player-pokemon-name').textContent = `${player.name} (Niv.${player.level})`;
                document.getElementById('player-pokemon-hp-text').textContent = `PV: ${Math.max(0, player.currentHp)}/${player.maxHp}`;
                
                const playerHpPercent = (player.currentHp / player.maxHp) * 100;
                const playerHpBar = document.getElementById('player-hp');
                playerHpBar.style.width = playerHpPercent + '%';
                playerHpBar.className = 'hp-fill' + (playerHpPercent < 30 ? ' low' : '');
            },

            addBattleLog(message) {
                const log = document.getElementById('battle-log');
                const entry = document.createElement('div');
                entry.className = 'log-entry';
                entry.textContent = message;
                log.appendChild(entry);
                log.scrollTop = log.scrollHeight;
            },

            battle: {
                attack() {
                    if (!game.battle) return;

                    const playerDamage = Math.floor(Math.random() * 20) + game.battle.player.attack;
                    game.battle.wild.currentHp -= playerDamage;
                    game.addBattleLog(`${game.battle.player.name} attaque et inflige ${playerDamage} d√©g√¢ts !`);

                    if (game.battle.wild.currentHp <= 0) {
                        game.addBattleLog(`${game.battle.wild.name} est K.O. ! Victoire !`);
                        game.battle.player.level++;
                        game.addBattleLog(`${game.battle.player.name} monte au niveau ${game.battle.player.level} !`);
                        setTimeout(() => game.endBattle(), 2000);
                        return;
                    }

                    game.updateBattleDisplay();

                    setTimeout(() => {
                        const wildDamage = Math.floor(Math.random() * 15) + game.battle.wild.attack;
                        game.battle.player.currentHp -= wildDamage;
                        game.addBattleLog(`${game.battle.wild.name} attaque et inflige ${wildDamage} d√©g√¢ts !`);

                        if (game.battle.player.currentHp <= 0) {
                            game.addBattleLog(`${game.battle.player.name} est K.O. ! Vous avez perdu...`);
                            game.battle.player.currentHp = 1;
                            setTimeout(() => game.endBattle(), 2000);
                            return;
                        }

                        game.updateBattleDisplay();
                    }, 1000);
                },

                capture() {
                    if (!game.battle) return;
                    
                    if (game.player.pokeballs <= 0) {
                        game.addBattleLog("Vous n'avez plus de Pok√©balls !");
                        return;
                    }

                    game.player.pokeballs--;
                    document.getElementById('pokeball-count').textContent = game.player.pokeballs;

                    const captureRate = (1 - game.battle.wild.currentHp / game.battle.wild.maxHp) * 0.6 + 0.2;
                    const captured = Math.random() < captureRate;

                    game.addBattleLog(`Vous lancez une Pok√©ball...`);

                    setTimeout(() => {
                        if (captured) {
                            game.addBattleLog(`Gotcha ! ${game.battle.wild.name} a √©t√© captur√© !`);
                            game.battle.wild.currentHp = game.battle.wild.maxHp;
                            game.player.team.push({...game.battle.wild});
                            game.updateTeamDisplay();
                            setTimeout(() => game.endBattle(), 2000);
                        } else {
                            game.addBattleLog(`Oh non ! ${game.battle.wild.name} s'est √©chapp√© !`);
                        }
                    }, 1500);
                },

                flee() {
                    if (!game.battle) return;
                    game.addBattleLog("Vous prenez la fuite !");
                    setTimeout(() => game.endBattle(), 1000);
                }
            },

            endBattle() {
                document.getElementById('battle').classList.remove('active');
                document.getElementById('battle-log').innerHTML = '';
                this.battle = null;
                this.updateTeamDisplay();
            },

            updateTeamDisplay() {
                const teamList = document.getElementById('team-list');
                teamList.innerHTML = '';
                this.player.team.forEach(pokemon => {
                    const div = document.createElement('div');
                    div.className = 'team-pokemon';
                    div.innerHTML = `
                        <div class="team-pokemon-shape" style="background-color: ${pokemon.color}"></div>
                        <span>${pokemon.name} Niv.${pokemon.level} (${pokemon.currentHp}/${pokemon.maxHp} PV)</span>
                    `;
                    teamList.appendChild(div);
                });
            },

            showDialogue(text, callback = null) {
                this.dialogue.active = true;
                this.dialogue.callback = callback;
                document.getElementById('dialogue-text').textContent = text;
                document.getElementById('dialogue').classList.add('active');
                document.getElementById('dialogue-choices').innerHTML = '';
                document.getElementById('dialogue-continue').style.display = 'block';
            },

            closeDialogue() {
                this.dialogue.active = false;
                document.getElementById('dialogue').classList.remove('active');
                if (this.dialogue.callback) {
                    const cb = this.dialogue.callback;
                    this.dialogue.callback = null;
                    cb();
                }
            },

            gameLoop() {
                this.update();
                this.draw();
                requestAnimationFrame(() => this.gameLoop());
            }
        };

        // D√©marrage du jeu
        window.addEventListener('load', () => {
            game.init();
        });
    </script>
</body>
</html>
